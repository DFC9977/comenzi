<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comenzi Gosbi</title>
  <link rel="stylesheet" href="./styles.css" />

  <!-- Dev hint: Ã®n Chrome devtools poÈ›i testa fÄƒrÄƒ SW cu ?nosw=1 -->
</head>

<body>

  <!-- HEADER -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">G</div>
      <div>
        <div class="title">Comenzi Gosbi</div>
        <div class="subtitle" id="sessionInfo">Neautentificat</div>
      </div>
    </div>

    <div class="actions" id="topbarActions">
      <!-- CLIENT -->
      <button id="btnOrders" class="btn ghost nav-btn" style="display:none;">Comenzi</button>
      <button id="btnPromos" class="btn ghost nav-btn" style="display:none; position:relative;">
        PromoÈ›ii
        <span id="badgePromos" style="display:none;position:absolute;top:-6px;right:-6px;background:#ff5d5d;color:#fff;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:900;align-items:center;justify-content:center;z-index:2;"></span>
      </button>

      <!-- ADMIN -->
      <button id="btnAdminClients" class="btn ghost nav-btn" style="display:none;">ClienÈ›i</button>
      <button id="btnAdminPromos" class="btn ghost nav-btn" style="display:none;">PromoÈ›ii</button>
      <button id="btnAdminCounties" class="btn ghost nav-btn" style="display:none;">JudeÈ›e</button>
      <button id="btnReports" class="btn ghost nav-btn" style="display:none;">Rapoarte</button>

      <!-- COMUN -->
      <button id="btnMessages" class="btn ghost nav-btn" style="display:none; position:relative;">
        Mesaje
        <span id="badgeMessages" style="display:none;position:absolute;top:-6px;right:-6px;background:#ff5d5d;color:#fff;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:900;align-items:center;justify-content:center;z-index:2;"></span>
      </button>

      <!-- SchimbÄƒ parola (doar client logat) -->
      <button id="btnChangePass" class="btn ghost" style="display:none;" title="SchimbÄƒ parola">ğŸ”‘</button>

      <button id="btnLogout" class="btn ghost" hidden>Logout</button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">

    <!-- LOADING -->
    <section id="screenLoading" class="card">
      <h2>Se Ã®ncarcÄƒâ€¦</h2>
      <p class="muted">Verific sesiunea È™i profilul.</p>
    </section>

    <!-- LOGIN -->
    <section id="screenLogin" class="card" hidden>
      <h2>Autentificare</h2>
      <p class="muted">Login cu telefon + parolÄƒ</p>

      <div class="grid">
        <label class="field">
          <span>Telefon</span>
          <input id="loginPhone" type="tel" inputmode="tel" placeholder="07xxxxxxxx" autocomplete="username" />
        </label>

        <label class="field">
          <span>ParolÄƒ</span>
          <input id="loginPass" type="password" placeholder="Parola" autocomplete="current-password" />
        </label>
      </div>

      <div class="row">
        <button id="btnLogin" class="btn primary">Login</button>
        <button id="btnRegister" class="btn">CreeazÄƒ cont</button>
      </div>

      <div id="loginMsg" class="note" hidden></div>

      <div style="text-align:center; margin-top:14px;">
        <button id="btnShowForgot" type="button" style="background:none;border:none;color:#4da3ff;font-size:13px;cursor:pointer;padding:4px;text-decoration:underline;">
          Am uitat parola
        </button>
      </div>

      <!-- FORGOT PASSWORD FORM (hidden by default) -->
      <div id="forgotSection" hidden style="margin-top:16px;border-top:1px solid rgba(255,255,255,.08);padding-top:16px;">
        <h3 style="font-size:15px;margin-bottom:6px;">Resetare parolÄƒ</h3>
        <p class="muted" style="font-size:13px;margin-bottom:12px;">
          Introdu numÄƒrul tÄƒu de telefon. Adminul va primi cererea È™i te va contacta cu o parolÄƒ nouÄƒ.
        </p>
        <div class="grid">
          <label class="field">
            <span>Telefon</span>
            <input id="forgotPhone" type="tel" inputmode="tel" placeholder="07xxxxxxxx" />
          </label>
        </div>
        <div class="row">
          <button id="btnSendReset" class="btn primary">Trimite cererea</button>
          <button id="btnCancelReset" class="btn">Ãnapoi</button>
        </div>
        <div id="forgotMsg" class="note" hidden></div>
      </div>
    </section>

    <!-- CONTACT GATE -->
    <section id="screenContactGate" class="card" hidden>
      <h2>Date de contact</h2>
      <p class="muted">Pentru a vedea produsele, te rugÄƒm sÄƒ completezi datele de contact.</p>

      <div class="grid">

        <label class="field">
          <span>Nume complet</span>
          <input id="fullName" placeholder="Nume Prenume" />
        </label>

        <label class="field">
          <span>CanisÄƒ / FelisÄƒ</span>
          <input id="kennel" placeholder="Denumire canisÄƒ / felisa (opÈ›ional)" />
        </label>

        <label class="field">
          <span>AdresÄƒ completÄƒ</span>
          <textarea id="address" rows="3" placeholder="StradÄƒ, nr., bloc, sc., ap., etc."></textarea>
        </label>

        <label class="field">
          <span>JudeÈ›</span>
          <select id="countySelect">
            <option value="">SelecteazÄƒ judeÈ›</option>
          </select>
        </label>

        <label class="field">
          <span>Localitate</span>
          <input id="cityInput" list="cityList" disabled />
          <datalist id="cityList"></datalist>
          <div class="hint">Localitatea se activeazÄƒ dupÄƒ alegerea judeÈ›ului.</div>
        </label>

      </div>

      <div class="row">
        <button id="btnSaveContact" class="btn primary">SalveazÄƒ È™i continuÄƒ</button>
        <button id="btnBackToLogin" class="btn ghost">Ãnapoi</button>
      </div>

      <div id="contactMsg" class="note" hidden></div>
    </section>

    <!-- CATALOG -->
    <section id="screenCatalog" class="card" hidden>
      <div class="row between">
        <div>
          <h2>Catalog</h2>
          <p id="catalogHint" class="muted"></p>
        </div>

        <button id="btnRefreshProducts" class="btn">Refresh</button>
      </div>

      <div id="productsGrid" class="products"></div>
    </section>

    <!-- ADMIN (Ã®n aceeaÈ™i aplicaÈ›ie, nu tab nou) -->
    <section id="screenAdmin" class="card" hidden>
      <div class="row between">
        <div>
          <h2 id="adminFrameTitle">Comenzile mele</h2>
          <p class="muted" id="adminFrameSubtitle"></p>
        </div>
        <button id="btnBackToCatalog" class="btn">Ãnapoi la catalog</button>
      </div>

      <iframe
        id="adminFrame"
        src="./admin.html"
        style="width:100%; height:75vh; border:0; border-radius:14px;"
      ></iframe>
    </section>

  </main>

  <footer class="footer">
    <span class="muted">v1 â€¢ Firebase Spark â€¢ GitHub Pages</span>
  </footer>

  <!-- CHANGE PASSWORD SHEET -->
  <div id="cpOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9998;"></div>
  <div id="cpSheet" style="
    position:fixed;left:0;right:0;bottom:0;
    transform:translateY(110%);transition:transform .22s ease;
    z-index:9999;background:#0d1117;
    border-top:1px solid rgba(255,255,255,.12);
    border-radius:16px 16px 0 0;
    padding:20px;max-width:500px;margin:0 auto;
  ">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div style="font-weight:900;font-size:16px;">ğŸ”‘ SchimbÄƒ parola</div>
      <button id="cpClose" type="button" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;border-radius:10px;padding:6px 12px;cursor:pointer;font-weight:700;">âœ•</button>
    </div>
    <div style="display:grid;gap:10px;margin-bottom:14px;">
      <input id="cpOld" type="password" placeholder="Parola curentÄƒ"
        style="padding:13px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;font-size:15px;" />
      <input id="cpNew" type="password" placeholder="Parola nouÄƒ (min 6 caractere)"
        style="padding:13px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;font-size:15px;" />
      <input id="cpConf" type="password" placeholder="ConfirmÄƒ parola nouÄƒ"
        style="padding:13px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;font-size:15px;" />
    </div>
    <button id="cpSave" type="button" style="width:100%;padding:15px;border-radius:14px;border:none;background:#4da3ff;color:#07111d;font-weight:900;font-size:16px;cursor:pointer;">
      SalveazÄƒ parola
    </button>
    <div id="cpMsg" style="margin-top:10px;font-size:14px;min-height:18px;"></div>
  </div>

  <!-- IMPORTANT:
       - bump APP_VER cÃ¢nd vrei sÄƒ fii sigur cÄƒ browserul ia JS nou
       - ex: APP_VER = 41, 42, 43...
  -->
  <script>
    window.APP_VER = 42;
  </script>
  <script type="module" src="./js/app.js?v=42"></script>

  <!-- SERVICE WORKER CONTROL (dev/prod friendly) -->
  <script>
    (function () {
      // Switch-uri rapide din URL:
      //  - ?nosw=1  => NU folosi SW (ideal cÃ¢nd testezi)
      //  - ?sw=1    => forÈ›eazÄƒ SW chiar dacÄƒ nu e web.app
      const params = new URLSearchParams(location.search);
      const forceNoSW = params.get("nosw") === "1";
      const forceSW = params.get("sw") === "1";

      // Detect:
      const isLocalhost =
        location.hostname === "localhost" ||
        location.hostname === "127.0.0.1" ||
        location.hostname.endsWith(".local");

      const isFirebaseHosting =
        location.hostname.endsWith(".web.app") ||
        location.hostname.endsWith(".firebaseapp.com");

      // RegulÄƒ:
      // - default: SW DOAR Ã®n producÈ›ie (Firebase Hosting)
      // - dev/local: fÄƒrÄƒ SW
      const enableSW = !forceNoSW && (forceSW || (isFirebaseHosting && !isLocalhost));

      if (!("serviceWorker" in navigator)) return;

      // DacÄƒ nu vrem SW: Ã®l scoatem complet (unregister) ca sÄƒ nu mai Ã®ncurce.
      if (!enableSW) {
        navigator.serviceWorker.getRegistrations()
          .then((regs) => Promise.all(regs.map((r) => r.unregister())))
          .catch(() => {});
        return;
      }

      // DacÄƒ vrem SW: Ã®l Ã®nregistrÄƒm + forÈ›Äƒm update.
      window.addEventListener("load", async () => {
        try {
          const reg = await navigator.serviceWorker.register("./sw.js");

          // ForÈ›eazÄƒ sÄƒ caute o versiune nouÄƒ
          if (reg && typeof reg.update === "function") {
            reg.update().catch(() => {});
          }

          // DacÄƒ apare un SW nou instalat, facem refresh automat ca sÄƒ vezi modificÄƒrile imediat
          reg.addEventListener("updatefound", () => {
            const nw = reg.installing;
            if (!nw) return;
            nw.addEventListener("statechange", () => {
              if (nw.state === "installed" && navigator.serviceWorker.controller) {
                // existÄƒ update, reÃ®ncarcÄƒ
                location.reload();
              }
            });
          });

          // DacÄƒ se schimbÄƒ controllerul, reÃ®ncarcÄƒ o datÄƒ
          let reloaded = false;
          navigator.serviceWorker.addEventListener("controllerchange", () => {
            if (reloaded) return;
            reloaded = true;
            location.reload();
          });
        } catch (e) {
          console.warn("SW register failed:", e);
        }
      });
    })();
  </script>

</body>
</html>